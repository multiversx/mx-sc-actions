name: Wasm Tests

on:
  workflow_call:
    inputs:
      rust-toolchain:
        description: "Rust toolchain to use"
        default: "stable"
        required: false
        type: string
      runs-on:
        description: "The type of machine to run the job on"
        default: "ubuntu-latest"
        required: false
        type: string
      rust-target:
        description: "Rust target to use"
        default: "wasm32-unknown-unknown"
        required: false
        type: string
      enable-contracts-size-report:
        description: "Enable contracts size report"
        default: true
        required: false
        type: boolean

jobs:
  wasm_test:
    name: Wasm tests
    runs-on: ${{ inputs.runs-on }}
    steps:
      - uses: actions/checkout@v5

      - name: Install rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ inputs.rust-toolchain }}
          target: ${{ inputs.rust-target }}

      - name: Create local tools directory
        run: mkdir -p tools

      - name: Download sc-meta artifact
        uses: actions/download-artifact@v6
        with:
          name: sc-meta
          path: tools

      - name: Download mx-scenario-go artifact
        uses: actions/download-artifact@v6
        with:
          name: mx-scenario-go
          path: tools

      - name: Set tools' path
        run: |
          tar -xvf tools/sc_meta.tar -C tools
          tar -xvf tools/mx_scenario_go.tar -C tools

          for tool in sc-meta mx-scenario-go wasm-opt; do
            FOUND=$(find tools -name "$tool" -type f | head -n1)
            if [ -n "$FOUND" ]; then
              mv "$FOUND" tools/
            fi
          done

          find tools -name "*.so" -type f -exec mv {} tools/ \;
          find tools -name "*.a" -type f -exec mv {} tools/ \;
          find tools -type d -empty -delete
          echo "$(pwd)/tools" >> "$GITHUB_PATH"

      - name: Download built contracts
        uses: actions/download-artifact@v6
        with:
          name: built-contracts
          path: .

      - name: Run the wasm tests
        env:
          RUSTFLAGS: ""
        run: |
          LD_LIBRARY_PATH="$(pwd)/tools"
          export LD_LIBRARY_PATH
          sc-meta test --go

      - name: Generate the contract report
        if: ${{ inputs.enable-contracts-size-report }}
        env:
          RUSTFLAGS: ""
        run: sc-meta report compile --path . --output report.json

      - name: Upload the report json
        if: ${{ inputs.enable-contracts-size-report }}
        uses: actions/upload-artifact@v5
        with:
          name: report
          path: report.json

      - name: Download the base report
        uses: dawidd6/action-download-artifact@v11
        if: ${{ github.event_name == 'pull_request' && inputs.enable-contracts-size-report }}
        continue-on-error: true
        with:
          workflow: actions.yml
          name: report
          commit: ${{ github.event.pull_request.base.sha }}
          path: base-report

      - name: Generate the report template
        if: ${{ github.event_name == 'pull_request'  && inputs.enable-contracts-size-report }}
        run: |
          echo "Contract comparison - from {{ .base }} to {{ .head }}" > report.md
          sc-meta report compare --baseline base-report/report.json --new report.json --output report-table.md
          cat report-table.md >> report.md

      - name: Render the report from the template
        id: template
        uses: chuhlomin/render-template@v1
        if: ${{ github.event_name == 'pull_request' && inputs.enable-contracts-size-report }}
        with:
          template: report.md
          vars: |
            base: ${{ github.event.pull_request.base.sha }}
            head: ${{ github.event.pull_request.head.sha }}

      - name: Upload the report markdown
        uses: actions/upload-artifact@v5
        if: ${{ github.event_name == 'pull_request' && inputs.enable-contracts-size-report }}
        with:
          name: report-markdown
          path: report.md

      - name: Find the comment containing the report
        id: fc
        uses: peter-evans/find-comment@v4
        if: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository  && inputs.enable-contracts-size-report }}
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: "Contract comparison"

      - name: Create or update the report comment
        uses: peter-evans/create-or-update-comment@v5
        if: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository  && inputs.enable-contracts-size-report }}
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.template.outputs.result }}
          edit-mode: replace

      - name: Cleanup
        run: rm -rf tools